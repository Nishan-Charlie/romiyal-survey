<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Curriculum User Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        .font-inter { font-family: 'Inter', sans-serif; }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 1rem;
            height: 1rem;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <script type="module">
        // --- GLOBAL CONFIGURATION & STATE ---
        // The backend endpoint that will securely call the Gemini API
        const classifyApiUrl = '/classify'; // Assumes the Flask app is serving on the same origin
        const socket = io();
        
        window.state = { 
            userId: 'local-user-' + Math.random().toString(36).substr(2, 5),
            adminQuestion: 'What is your primary learning objective regarding the use of AI in medicine?', 
            userResponses: [] 
        };

        // AI CLASSIFICATION CONFIG (mirrors the Pydantic schema for structured output)
        const SYSTEM_PROMPT = `You are a world-class expert in classifying learning objectives and content related to Artificial Intelligence in Health Sciences Education. Your task is to analyze the provided text (a user's answer/objective) and classify it into one of the following five domains with high accuracy. You must strictly adhere to the provided JSON schema for your output.
        The five official domains are:
        1. Clinical Decision Support Systems (CDSS)
        2. Data Science & Analytics Skills (DSAS)
        3. Ethical, Legal, and Social Implications (ELSI)
        4. Medical Imaging & Diagnostics (MID)
        5. Patient Engagement & Monitoring (PEM)`;

        // JSON schema for the AI model to ensure structured, predictable output
        const RESPONSE_SCHEMA = {
            type: "OBJECT",
            properties: {
                "primaryDomain": { "type": "STRING", "description": "The most relevant domain from the list." },
                "confidenceScore": { "type": "NUMBER", "description": "The confidence of the classification, between 0.0 and 1.0, formatted to two decimal places." },
                "justification": { "type": "STRING", "description": "A concise, single-sentence explanation for the chosen classification." }
            },
            "required": ["primaryDomain", "confidenceScore", "justification"],
            "propertyOrdering": ["primaryDomain", "confidenceScore", "justification"]
        };


        // --- UTILITY FUNCTIONS ---
        const delay = ms => new Promise(resolve => setTimeout(resolve, ms));

        /** Displays a temporary feedback message to the user. */
        function showTemporaryMessage(message, type) {
            const container = document.getElementById('temporaryMessageContainer');
            container.innerHTML = '';
            const bgColor = type === 'success' ? 'bg-green-100 border-green-400 text-green-700' : 'bg-red-100 border-red-400 text-red-700';
            const html = `<div class="p-3 border ${bgColor} rounded-xl mb-4 shadow-md"><p class="font-semibold">${message}</p></div>`;
            container.innerHTML = html;
            setTimeout(() => { container.innerHTML = ''; }, 5000);
        }

        /** Handles API calls with exponential backoff for rate limiting. */
        async function fetchWithRetry(url, options, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) return response;
                    if (response.status === 429 && i < maxRetries - 1) {
                        const backoffTime = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await delay(backoffTime);
                        continue;
                    }
                    throw new Error(`API returned status code ${response.status}`);
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    const backoffTime = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await delay(backoffTime);
                }
            }
        }

        // --- PAGE INITIALIZATION & REAL-TIME LISTENERS ---
        function initializePage() {
            // Set a default user ID
            document.getElementById('currentUserId').textContent = window.state.userId;
            document.getElementById('submitView').classList.remove('hidden');

            // Listen for state updates from the server
            socket.on('state_update', (data) => {
                console.log('Received state update from server:', data);
                window.state.adminQuestion = data.question;
                window.state.userResponses = data.responses;
                document.getElementById('currentQuestionDisplay').textContent = data.question;
                updateAnalysisView();
            });
        }

        // --- USER SUBMISSION LOGIC ---

        /** Submits the user's answer, calls the AI for classification, and updates the local view. */
        window.submitAnswer = async function() {
            const answerTextarea = document.getElementById('userAnswerTextarea');
            const answerText = answerTextarea.value.trim();

            if (!answerText) {
                showTemporaryMessage('Please enter your answer.', 'error');
                return;
            }
            
            // UI State: Loading
            const button = document.getElementById('submitAnswerButton');
            button.disabled = true;
            document.getElementById('submitButtonText').textContent = 'Classifying & Submitting...';
            document.getElementById('loadingSpinner').classList.remove('hidden');
            document.getElementById('individualClassificationResult').classList.add('hidden');

            try {
                // 1. Call AI Model
                const response = await fetchWithRetry(classifyApiUrl, {
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ answer: answerText })
                });
                const classificationData = await response.json();

                if (!classificationData.primaryDomain) {
                    throw new Error(classificationData.error || "Invalid classification data received from server.");
                }

                // The server will broadcast the new state, which our listener will handle.
                // We just need to display the result for this specific user.
                displayIndividualClassification(classificationData);

                answerTextarea.value = '';
                showTemporaryMessage('Success! Your answer has been submitted and classified.', 'success');

            } catch (error) {
                console.error('Submission Error:', error);
                showTemporaryMessage(`Submission failed: ${error.message}.`, 'error');
            } finally {
                // UI State: Ready
                button.disabled = false;
                document.getElementById('submitButtonText').textContent = 'Submit Answer & Classify';
                document.getElementById('loadingSpinner').classList.add('hidden');
            }
        }

        /** Renders the classification results for the single submission. */
        function displayIndividualClassification(data) {
            const resultDiv = document.getElementById('individualClassificationResult');
            // Ensure confidence score is valid before calculation
            const score = Math.max(0, Math.min(1, data.confidenceScore || 0));
            const scorePercent = (score * 100).toFixed(0);
            const scoreColor = score >= 0.8 ? 'bg-green-500' : score >= 0.5 ? 'bg-yellow-500' : 'bg-red-500';

            resultDiv.innerHTML = `
                <h3 class="text-xl font-bold text-gray-800 mb-3 border-b pb-2">Your Classification Result</h3>
                <div class="p-4 bg-blue-50 border-l-4 border-blue-600 rounded-lg mb-4">
                    <p class="text-lg font-semibold text-blue-800">Category: <span class="font-extrabold">${data.primaryDomain}</span></p>
                </div>
                <div class="bg-white border border-gray-200 rounded-lg p-3 mb-4 shadow-sm">
                    <p class="text-sm font-semibold text-gray-700">Confidence:</p>
                    <div class="flex items-center mt-1">
                        <span class="text-lg font-bold text-gray-900 mr-3">${scorePercent}%</span>
                        <div class="w-full bg-gray-200 rounded-full h-3">
                            <div class="h-3 rounded-full ${scoreColor} transition-all duration-500 shadow-inner" style="width: ${scorePercent}%;"></div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-3 shadow-inner">
                    <p class="text-sm font-semibold text-gray-700">Reason / Explanation:</p>
                    <p class="text-gray-600 italic text-sm mt-1">${data.justification}</p>
                </div>
            `;
            resultDiv.classList.remove('hidden');
        }

        // --- ANALYSIS VIEW LOGIC (D3.js & Data Table) ---

        /** Updates the count, chart, and data table based on new response data. */
        function updateAnalysisView() {
            document.getElementById('totalResponsesCount').textContent = window.state.userResponses.length;
            
            const summary = window.state.userResponses.reduce((acc, response) => {
                const domain = response.classification?.primaryDomain || 'Unclassified';
                acc[domain] = (acc[domain] || 0) + 1;
                return acc;
            }, {});

            renderBarChart(summary);
            renderDataTable(window.state.userResponses);
        }

        /** Renders the D3.js bar chart for domain breakdown. */
        function renderBarChart(summary) {
            const chartDiv = document.getElementById('classificationChart');
            chartDiv.innerHTML = '';
            
            const data = Object.entries(summary).map(([domain, count]) => ({ domain, count })).sort((a, b) => b.count - a.count);

            if (data.length === 0) {
                chartDiv.innerHTML = '<p class="text-center text-gray-500 mt-8">No data submitted yet to generate a chart.</p>';
                return;
            }

            // Responsive sizing logic
            const parentWidth = chartDiv.parentElement.clientWidth;
            const width = Math.min(800, parentWidth - 40);
            const height = 350;
            const margin = { top: 20, right: 30, bottom: 100, left: 60 };
            const innerWidth = width - margin.left - margin.right;
            const innerHeight = height - margin.top - margin.bottom;

            const svg = d3.select("#classificationChart").append("svg")
                .attr("width", width).attr("height", height).style("display", "block").style("margin", "0 auto")
                .append("g").attr("transform", `translate(${margin.left},${margin.top})`);

            const x = d3.scaleBand().range([0, innerWidth]).domain(data.map(d => d.domain)).padding(0.3);
            const y = d3.scaleLinear().domain([0, d3.max(data, d => d.count) || 1]).range([innerHeight, 0]);

            // Axes
            svg.append("g").attr("transform", `translate(0,${innerHeight})`).call(d3.axisBottom(x))
                .selectAll("text").attr("transform", "translate(-10,0)rotate(-45)").style("text-anchor", "end").style("font-size", "12px").style("fill", "#4b5563");
            
            svg.append("g").call(d3.axisLeft(y).tickFormat(d3.format("d")));

            // Bars and Labels
            svg.selectAll("mybar").data(data).join("rect")
                .attr("x", d => x(d.domain)).attr("y", d => y(d.count)).attr("width", x.bandwidth())
                .attr("height", d => innerHeight - y(d.count)).attr("fill", "#3b82f6").attr("rx", 6)
                .style("box-shadow", "0 2px 4px rgba(0,0,0,0.1)");
            
            svg.selectAll(".bar-label").data(data).join("text")
                .attr("x", d => x(d.domain) + x.bandwidth() / 2).attr("y", d => y(d.count) - 7)
                .attr("text-anchor", "middle").text(d => d.count).style("fill", "#1f2937").style("font-size", "14px").style("font-weight", "700");
        }

        /** Renders the raw data in the HTML table. */
        function renderDataTable(responses) {
            const tableBody = document.getElementById('classificationTableBody');
            tableBody.innerHTML = '';
            if (responses.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" class="py-4 text-center text-gray-500">No responses collected yet.</td></tr>';
                return;
            }

            // Sort by latest timestamp first
            responses.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

            responses.forEach(response => {
                const date = response.timestamp ? new Date(response.timestamp.seconds * 1000).toLocaleString() : 'N/A';
                const domain = response.classification?.primaryDomain || 'N/A';
                const justification = response.classification?.justification || 'No justification provided.';
                
                const row = document.createElement('tr');
                row.className = 'border-b last:border-b-0 hover:bg-gray-50 transition duration-150';
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm font-medium text-gray-900">${response.answer.substring(0, 70)}...</td>
                    <td class="px-4 py-3 text-sm text-blue-600 font-semibold">${domain}</td>
                    <td class="px-4 py-3 text-xs text-gray-500">${justification.substring(0, 100)}...</td>
                    <td class="px-4 py-3 text-xs text-gray-400">${date}</td>
                `;
                tableBody.appendChild(row);
            });
        }


        // --- EXPORT FUNCTIONS ---

        /** Exports all data as a CSV file. */
        window.exportCSV = function() {
            const data = window.state.userResponses;
            if (data.length === 0) { showTemporaryMessage("No data to export.", 'error'); return; }

            let csvContent = "data:text/csv;charset=utf-8,";
            const headers = ["ID", "User ID", "Question", "Answer", "Domain", "Confidence Score", "Justification", "Timestamp"];
            csvContent += headers.join(",") + "\n";

            data.forEach(item => {
                const sanitize = (str) => `"${(str || '').toString().replace(/"/g, '""')}"`;
                const row = [
                    item.id, item.userId, sanitize(item.question), sanitize(item.answer),
                    item.classification?.primaryDomain || 'N/A', item.classification?.confidenceScore || 0,
                    sanitize(item.classification?.justification),
                    item.timestamp ? new Date(item.timestamp.seconds * 1000).toISOString() : 'N/A'
                ];
                csvContent += row.join(",") + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `ai_classification_data_${new Date().toISOString().substring(0, 10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        /** Exports the D3 chart as a PNG image. */
        window.exportImage = function() {
            const svgElement = document.querySelector("#classificationChart svg");
            if (!svgElement) { showTemporaryMessage("Chart not available for export.", 'error'); return; }

            const svgData = (new XMLSerializer()).serializeToString(svgElement);
            const canvas = document.createElement("canvas");
            const ctx = canvas.getContext("2d");
            
            const img = new Image();
            img.onload = () => {
                // Set canvas size based on the SVG dimensions
                canvas.width = svgElement.getAttribute('width');
                canvas.height = svgElement.getAttribute('height');
                
                // Draw white background
                ctx.fillStyle = "#ffffff";
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Draw the SVG content
                ctx.drawImage(img, 0, 0);

                const link = document.createElement('a');
                link.download = `classification_chart_${new Date().toISOString().substring(0, 10)}.png`;
                link.href = canvas.toDataURL('image/png');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };
            
            // Encode the SVG data to Base64
            img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent('<?xml version="1.0" standalone="no"?>\r\n' + svgData)));
        }

        // Start the application setup
        window.onload = initializePage;
    </script>
</head>
<body class="font-inter p-4 sm:p-8 min-h-screen flex items-start justify-center bg-gray-100">

    <div class="w-full max-w-6xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-900 mb-2">AI Curriculum User Submission</h1>
            <p class="text-gray-600">Submit your learning objective or answer to the prompt below for real-time AI classification.</p>
            <div class="mt-4 text-sm font-medium text-gray-700">
                <a href="/" class="text-indigo-600 hover:text-indigo-800 transition duration-150 underline font-semibold">Go to Admin Login</a>
            </div>
        </header>

        <div id="app" class="bg-white p-4 sm:p-8 rounded-2xl shadow-2xl border border-gray-200">
            <!-- Global Messages -->
            <div id="errorArea" class="mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-xl hidden shadow-md"></div>
            <div id="temporaryMessageContainer" class="mt-4"></div>
            

            <!-- SUBMISSION VIEW -->
            <div id="submitView" class="hidden">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-6 bg-blue-50 p-4 rounded-xl border border-blue-200">
                    <h2 class="text-xl font-bold text-gray-800">Submit Your Objective</h2>
                    <p class="text-sm font-medium text-blue-700 mt-2 sm:mt-0">
                        Your ID: <span class="font-mono text-xs p-1 bg-blue-100 rounded-md" id="currentUserId">Loading...</span>
                    </p>
                </div>
                
                <div class="p-4 bg-gray-50 border border-gray-200 rounded-xl mb-6 shadow-inner">
                    <p class="text-sm font-semibold text-gray-700 mb-2">Current Prompt:</p>
                    <p id="currentQuestionDisplay" class="text-lg font-medium text-gray-800">Loading question...</p>
                </div>

                <label for="userAnswerTextarea" class="block text-lg font-semibold text-gray-700 mb-3">Your Answer / Objective:</label>
                <textarea id="userAnswerTextarea" rows="6" class="w-full p-4 border border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500 transition duration-150 shadow-md" placeholder="Type your learning objective or answer here..."></textarea>

                <div class="flex justify-end mt-4 mb-8">
                    <button id="submitAnswerButton" class="px-8 py-3 bg-blue-600 text-white font-bold rounded-xl shadow-lg hover:bg-blue-700 transition duration-200 flex items-center transform hover:scale-[1.01] active:scale-[0.99]" onclick="submitAnswer()">
                        <span id="submitButtonText">Submit Answer & Classify</span>
                        <div id="loadingSpinner" class="spinner ml-3 hidden"></div>
                    </button>
                </div>

                <!-- Individual Classification Result Area -->
                <div id="individualClassificationResult" class="p-6 bg-white border border-dashed border-blue-300 rounded-xl mb-10 shadow-inner hidden">
                    <!-- Classification result (category, reason) of the single submission will be injected here -->
                </div>
                
                <hr class="my-10 border-gray-200">

                <!-- AGGREGATE ANALYSIS (Chart and Table) -->
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Live Aggregated Results</h2>

                <div class="flex flex-wrap items-center justify-between gap-3 mb-6 p-4 bg-gray-50 rounded-xl border border-gray-200 shadow-sm">
                    <p class="text-xl font-medium text-gray-700">Total Responses: <span id="totalResponsesCount" class="text-blue-600 font-extrabold text-2xl">0</span></p>
                    <div class="space-x-3">
                        <button onclick="exportCSV()" class="px-4 py-2 text-sm bg-gray-200 text-gray-700 font-medium rounded-xl hover:bg-gray-300 transition duration-150 shadow-md">
                            Download Data (CSV)
                        </button>
                        <button onclick="exportImage()" class="px-4 py-2 text-sm bg-gray-200 text-gray-700 font-medium rounded-xl hover:bg-gray-300 transition duration-150 shadow-md">
                            Download Chart (PNG)
                        </button>
                    </div>
                </div>

                <!-- Classification Graph -->
                <div class="bg-white p-6 rounded-xl border border-gray-200 mb-8 shadow-md">
                    <h3 class="text-xl font-semibold text-gray-800 mb-5 text-center border-b pb-2">Domain Classification Breakdown (Chart)</h3>
                    <div id="classificationChart" class="w-full overflow-x-auto">
                        <!-- D3.js chart will be rendered here -->
                    </div>
                </div>

                <!-- Raw Data Table / Chat View -->
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Latest Responses (Raw Data)</h3>
                <div class="overflow-x-auto bg-white border border-gray-200 rounded-xl shadow-lg">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-5/12">User Answer Snippet</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-2/12">AI Category</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-4/12">AI Reason/Explanation</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/12">Date</th>
                            </tr>
                        </thead>
                        <tbody id="classificationTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Data rows will be injected here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <footer class="mt-8 pt-4 border-t text-center text-sm text-gray-500">
                Classification powered by Gemini. Aggregated results are for demonstration only.
            </footer>
        </div>
    </div>
</body>
</html>
